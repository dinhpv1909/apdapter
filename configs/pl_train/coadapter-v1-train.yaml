model:
  base_learning_rate: 1.0e-05
  target: adapters.coadapters.CoAdapter
  params:
    adapter_configs:
      - target: ldm.modules.encoders.adapter.StyleAdapter
        cond_name: style
        pretrained: models/t2iadapter_style_sd14v1.pth
        params:
          width: 1024
          context_dim: 768
          num_head: 8
          n_layes: 3
          num_token: 8

      - target: ldm.modules.encoders.adapter.Adapter
        cond_name: canny
        pretrained: models/t2iadapter_canny_sd14v1.pth
        params:
          cin: 64
          channels: [ 320, 640, 1280, 1280 ]
          nums_rb: 2
          ksize: 1
          sk: True
          use_conv: False

      - target: ldm.modules.encoders.adapter.Adapter
        cond_name: sketch
        pretrained: models/t2iadapter_sketch_sd14v1.pth
        params:
          cin: 64
          channels: [ 320, 640, 1280, 1280 ]
          nums_rb: 2
          ksize: 1
          sk: True
          use_conv: False

      - target: ldm.modules.encoders.adapter.Adapter_light
        cond_name: color
        pretrained: models/t2iadapter_color_sd14v1.pth
        params:
          cin: 192
          channels: [ 320, 640, 1280, 1280 ]
          nums_rb: 4

      - target: ldm.modules.encoders.adapter.Adapter
        cond_name: depth
        pretrained: models/t2iadapter_depth_sd14v1.pth
        params:
          cin: 192
          channels: [ 320, 640, 1280, 1280 ]
          nums_rb: 2
          ksize: 1
          sk: True
          use_conv: False

    coadapter_fuser_config:
      target: ldm.modules.encoders.adapter.CoAdapterFuser
      params:
        unet_channels: [320, 640, 1280, 1280]
        width: 768
        num_head: 8
        n_layes: 3

    noise_schedule: linear
    linear_start: 0.00085
    linear_end: 0.0120
    num_timesteps_cond: 1
    log_every_t: 200
    timesteps: 1000
    first_stage_key: "jpg"
    cond_stage_key: "txt"
    image_size: 64
    channels: 4
    cond_stage_trainable: false   # Note: different from the one we trained before
    conditioning_key: crossattn
    scale_factor: 0.18215
    use_ema: False

    ucg_training:
      txt: 0.5

    unet_config:
      target: ldm.modules.diffusionmodules.openaimodel.UNetModel
      params:
        image_size: 32 # unused
        in_channels: 4
        out_channels: 4
        model_channels: 320
        attention_resolutions: [ 4, 2, 1 ]
        num_res_blocks: 2
        channel_mult: [ 1, 2, 4, 4 ]
        num_heads: 8
        use_spatial_transformer: True
        transformer_depth: 1
        context_dim: 768
        use_checkpoint: True
        legacy: False

    first_stage_config:
      target: ldm.models.autoencoder.AutoencoderKL
      params:
        embed_dim: 4
        monitor: val/rec_loss
        ddconfig:
          double_z: true
          z_channels: 4
          resolution: 256
          in_channels: 3
          out_ch: 3
          ch: 128
          ch_mult:
          - 1
          - 2
          - 4
          - 4
          num_res_blocks: 2
          attn_resolutions: []
          dropout: 0.0
        lossconfig:
          target: torch.nn.Identity

    cond_stage_config: #__is_unconditional__
      target: ldm.modules.encoders.modules.FrozenCLIPEmbedder
      params:
        version: openai/clip-vit-large-patch14

data:
  target: ldm.data.dataset_laion.WebDataModuleFromConfig
  params:
    tar_base: /kaggle/input/data-tik/control_pose_per_vid # need to change
    batch_size: 2
    num_workers: 8
    multinode: True
    train:
      shards: ['279_1', '437', '515', '248', '503_6', '928_1', '625', '7', '843', '135', '386_3', '950_2', '529_3', '47', '604_1', '479', '123_4', '183', '354_2', '973', '768', '1044_4', '642', '1019_2', '166_2', '193_2', '313', '632_1', '795', '479_5', '369_3', '904_6', '600', '233_9', '267_3', '17', '724_2', '42_2', '81', '466', '479_4', '494', '429_1', '19', '199', '191_3', '972_2', '77_1', '480', '121', '823', '1004_1', '856', '695', '988', '106_8', '262', '653', '114_1', '87_1', '849', '168_1', '503_5', '910', '523', '431_3', '496', '743', '1044', '898_1', '1043', '192', '1083_4', '763', '395', '1082', '429', '884', '485', '1010_1', '762', '621', '2_1', '463', '117_1', '22', '233_4', '2', '837_2', '161_1', '693_6', '124_2', '869', '874', '330', '363', '229', '858', '839_1', '664', '519', '955', '1073', '240', '244', '783_6', '419', '1089', '253', '514', '723', '651', '605_2', '406', '309', '1092', '851', '707', '164', '1071', '616', '147', '1067', '145', '1055', '818', '213', '137', '807', '1013_4', '542', '422_1', '783_5', '988_1', '720', '371_3', '748', '667', '1079_1', '995', '369_2', '844', '532', '1041_1', '611', '35', '913', '414_4', '462', '250', '222', '946', '336', '92', '439_1', '976_1', '267_2', '892', '303', '447', '1060_1', '939', '765', '484', '738_2', '403', '446', '311', '924', '205', '1001_2', '1044_2', '207', '1058', '491', '353_6', '254', '350_3', '449', '206', '972', '50', '353_8', '503_1', '23', '87', '1084_1', '689', '352', '547', '15_1', '950', '605_4', '187', '994', '10', '994_5', '925', '594', '838', '212_1', '476', '913_3', '106_2', '770_3', '1072', '994_2', '5', '372', '726', '408', '662', '367', '230_1', '63_1', '928', '718_1', '966', '950_3', '318', '355', '1027_1', '947', '120', '353_3', '503_4', '61', '914', '650', '465', '405', '144_4', '1011', '402_1', '435', '900', '598_1', '970', '915', '36', '480_3', '1040', '769', '312_1', '788_4', '188', '566', '109', '949_2', '795_1', '459', '570_1', '7_2', '520_1', '750', '1032', '574_2', '587', '359', '1081_3', '989', '247', '424_1', '31_2', '48_1', '836_3', '406_1', '667_1', '478', '20', '369', '919', '430_3', '697', '521_2', '272', '1018', '734', '904_3', '698', '881', '994_4', '218', '355_1', '1030_3', '127', '150', '45', '55_1', '618', '443', '503', '60', '1027', '379', '214', '585', '533', '815', '27', '415', '186', '336_1', '444', '233', '123_1', '904_9', '775', '158', '392', '941', '304', '64', '41', '273', '163_1', '897', '1089_1', '811', '954_2', '971', '458', '339', '420_1', '434_1', '976_2', '782', '711_2', '1001', '521', '146', '866', '1083_1', '1016', '464_1', '89', '1019_1', '701', '210_1', '209', '1013_1', '73_1', '346', '124_1', '859', '479_3', '466_2', '221_3', '688', '175', '416', '39', '368_2', '545_2', '909', '949', '200_3', '526', '223', '732_1', '541_1', '506', '683', '992', '878', '719', '191_2', '745_1', '453', '920', '693_7', '770_2', '350_1', '386_2', '343', '798_1', '1041', '259', '480_4', '424_2', '604', '574_1', '1017_1', '32', '827_1', '331', '935', '862', '98', '292', '527', '564', '25', '913_4', '889', '217', '388_1', '324', '247_2', '956', '42', '226_1', '605_3', '955_1', '522_1', '895_1', '783_4', '1005', '430_5', '190', '490', '1030', '608', '52', '657_2', '338', '230', '640_3', '712', '717', '1079', '1045', '1048_4', '351', '1033_1', '727', '998_1', '863_1', '885', '1085', '1069', '64_1', '508', '617', '163_2', '101_1', '680', '994_1', '350', '75', '153_1', '1048_2', '184_3', '442_1', '776', '816_3', '8', '38', '148', '144_5', '274', '580_2', '1009', '962_1', '12', '901', '404', '522', '42_3', '268', '353_7', '780', '690', '257', '329', '789', '825', '303_6', '228_1', '503_3', '1084', '692', '1006_1', '94', '640_1', '234', '1037', '541', '783_3', '353_1', '820', '266', '634', '829', '123_3', '88_3', '1087', '1083_6', '434', '416_1', '754', '415_2', '952_1', '693_4', '1021', '718', '399', '450_1', '703_1', '325', '507', '166', '55', '375', '733', '1057', '97_1', '979_2', '662_1', '944', '752', '952', '630', '879', '614', '783_2', '258', '524', '603', '778', '105', '302', '544', '977', '474', '225_1', '49', '1044_1', '710', '674', '516', '898_2', '327', '904', '747', '225', '169_2', '112', '967', '479_2', '286', '646', '430_4', '460', '622', '873', '886', '575', '567', '393', '221_1', '832', '927', '442', '417', '130', '537', '320', '169', '593_1', '239_2', '733_2', '344_2', '308_2', '161', '962_2', '1040_2', '306', '684', '810', '371_1', '795_3', '854', '535', '151', '452', '811_1', '284_1', '982', '786', '656_1', '610', '729_1', '0', '215', '246_1', '979', '773', '202', '761', '502', '893', '184_4', '481', '278', '94_2', '790', '480_6', '626', '942', '724', '227', '193_4', '785', '570', '1052_1', '233_1', '362_2', '200', '813', '293_1', '899', '358_1', '767', '1096_2', '723_2', '651_2', '292_1', '312_2', '31', '344', '580_1', '412', '551_2', '931', '624_4', '189', '857_2', '62', '312', '852', '203', '114', '430', '712_1', '624_3', '53', '640', '702', '652', '1053', '483', '308', '1036', '929_3', '875', '976_3', '687', '212', '1042', '651_1', '410', '101', '493', '913_5', '432', '639_1', '67_4', '912', '954', '543_1', '686', '239_1', '70', '178', '609', '816', '1093', '606', '1002', '494_2', '569', '562', '193', '738_1', '135_1', '857_1', '624_2', '179_1', '348', '34', '18', '233_6', '520_3', '520', '517', '964', '247_1', '802_1', '433_1', '184_6', '106_5', '245_2', '409_1', '607_2', '180_1', '916', '794', '545', '645', '378', '333', '479_6', '245', '979_4', '303_5', '840', '791_5', '631', '890', '1010', '185', '341', '735', '264_2', '675_1', '79', '550_2', '174_3', '433', '441', '195', '705_1', '1025', '174_2', '792', '732', '448', '904_7', '583', '784_1', '156', '136_2', '699', '261', '85', '970_1', '512', '830_1', '425', '596', '791_2', '641', '88', '706', '655_1', '620', '789_1', '980', '518', '728', '65', '570_2', '184_5', '364', '635', '1039', '160', '67', '354_3', '504', '106', '494_1', '543', '904_8', '649_1', '545_1', '850', '174_4', '1036_1', '1022', '742', '624', '249', '877', '647', '799', '607_1', '560_1', '828', '235_1', '144_3', '853', '242', '934', '791_4', '545_3', '713', '495', '846_1', '913_2', '558', '194', '246_3', '663_1', '78', '138', '895_2', '797', '347', '200_1', '628', '305', '53_1', '291', '666', '1022_2', '256', '969', '28', '756_1', '337', '243', '166_4', '1022_3', '777', '808', '689_1', '791_1', '2_2', '806', '857', '177_4', '638', '882', '1019', '559', '360', '316', '417_1', '66', '284', '633_1', '783_7', '723_4', '473', '801', '420_4', '1090', '591', '184', '1023_1', '290', '1014', '73_2', '415_1', '226', '477', '745_2', '187_1', '963', '725_2', '598', '232', '857_4', '151_1', '809', '576', '197', '948', '929_2', '211', '235', '671', '56', '72', '445', '913_6', '16', '1024', '855', '55_2', '902', '191_1', '837_1', '721_1', '836_4', '905_2', '694', '391', '729', '1081', '557', '184_2', '781', '238', '113', '189_1', '362', '282', '411', '563', '361', '725_1', '221', '328', '100_1', '144_2', '498', '13', '245_1', '704', '580', '905_4', '503_2', '307', '827', '354', '904_1', '783_1', '267_4', '514_1', '548', '940', '550_3', '574_3', '353', '615', '342', '352_1', '389', '99', '721', '906_1', '106_3', '798_2', '239', '774', '298_1', '179_2', '1022_1', '681', '1030_1', '1012_1', '959', '420_2', '996', '740', '601', '672', '836_2', '845', '108', '179', '177_1', '836_1', '216', '1063', '408_1', '1086', '439', '353_4', '437_2', '791_3', '593', '1017', '721_2', '139', '368_3', '144_1', '78_1', '883', '233_5', '162', '414_2', '624_5', '104', '157', '919_2', '757', '586', '1088', '26', '1015', '659', '129', '418', '693', '551', '335', '655', '290_1', '1081_1', '74', '797_1', '277', '102_1', '716', '226_2', '570_3', '201', '264', '675', '470', '168', '887', '550_1', '251', '865', '504_2', '751', '124', '861', '299_1', '451', '379_1', '670', '612', '255', '283', '654', '351_1', '123', '31_1', '597', '345', '468', '986', '836', '237', '176', '1028', '436', '353_5', '590', '210', '221_2', '524_1', '371', '143_1', '797_2', '414_3', '133', '15', '356', '285', '629', '111', '115', '722', '455', '369_5', '783', '577', '3', '314', '501', '279', '90', '467', '231', '737', '106_7', '1030_2', '450', '198', '69', '270', '884_1', '1034_1', '131', '895', '117', '798', '280', '723_3', '349', '385', '555', '668', '219', '1038', '1076', '974', '171', '180', '898', '77', '872', '377', '1031', '424', '816_1', '871', '102', '344_3', '926', '24_1', '140', '1080', '86', '174', '466_1', '302_2', '390', '95', '1074', '706_1', '1062', '789_2', '67_3', '117_2', '43', '605_1', '627', '397', '561', '289', '480_2', '1075', '1082_1', '550', '1029', '556', '167', '795_2', '994_3', '1066', '91', '882_1', '540', '233_2', '279_2', '929_4', '71', '487', '509', '118_1', '1012', '791', '848', '965', '94_1', '350_2', '984', '445_1', '1007', '933', '943', '386_1', '1', '58', '1044_3', '771', '665', '711', '905_1', '136_1', '381', '700', '504_1', '376', '479_1', '752_2', '59', '908', '382', '536', '479_7', '15_2', '428', '241', '149', '177_3', '247_5', '471_1', '107', '847', '365_1', '370', '685', '169_3', '711_1', '155', '344_1', '88_2', '637', '800', '830', '426', '759', '302_3', '1001_1', '1026', '573', '770', '519_2', '226_4', '1083', '997', '665_1', '473_1', '141', '366', '1052', '1059', '413_1', '70_1', '123_2', '383', '299', '421', '184_1', '267_1', '837', '905_3', '810_2', '659_1', '546', '423', '387', '187_2', '401', '105_1', '236', '974_1', '951', '1_1', '529', '769_3', '97', '505', '208', '255_2', '714', '374', '30', '528', '340', '870', '247_3', '661', '836_5', '811_2', '292_2', '560', '119', '106_4', '482', '14', '275_1', '398', '139_1', '290_2', '506_1', '619', '855_1', '394', '344_4', '821', '643', '233_8', '159', '693_5', '1035', '480_7', '663', '703', '803', '983', '677', '1013', '300', '401_1', '539', '420_3', '36_1', '354_1', '793', '489', '1020_1', '346_1', '1091', '999', '945_3', '53_2', '182', '579', '369_1', '998', '76', '755', '772', '1056', '842', '302_4', '521_1', '839', '1010_2', '970_2', '265', '978_1', '143', '105_2', '693_1', '723_1', '741', '267', '708', '472', '957', '1013_3', '423_1', '589', '438', '414', '833', '945_2', '233_7', '599', '1033', '880', '386', '805', '62_1', '756_2', '824', '595', '1001_3', '464', '520_2', '644', '84', '4', '296', '1006', '949_1', '788_1', '1005_1', '174_5', '59_1', '1020', '400', '308_1', '310', '295', '431_1', '572', '822', '1004', '826', '83', '358', '531', '269', '233_3', '896', '151_2', '784', '457', '82', '745_3', '756', '69_1', '584', '293', '57', '819', '603_1', '1061', '678', '938', '640_2', '75_1', '904_5', '46_1', '529_2', '454', '152', '373', '1068', '103', '1047', '88_1', '9', '42_1', '67_1', '322', '760', '581', '830_2', '1049', '725', '456', '187_5', '173', '125', '228', '1078', '429_2', '607', '1048', '287', '144', '613', '738', '1044_5', '960', '170', '860', '985', '913_1', '863', '298_2', '422', '845_1', '96', '1048_1', '431', '163', '414_1', '252', '988_2', '602_1', '991', '500', '922', '437_1', '409', '733_3', '602', '923', '978', '224', '769_1', '36_2', '764', '945', '46', '971_1', '873_1', '945_1', '552', '1054_1', '639', '365', '669', '679', '413', '21', '166_3', '407', '769_2', '571', '961', '649', '990', '317', '380', '954_1', '906', '140_1', '705_2', '1077', '554', '276', '950_1', '497', '918', '195_1', '1070', '975', '731_1', '44', '142', '321', '126', '841', '943_1', '154', '40', '810_3', '80', '921', '911', '6', '746', '311_1', '461', '1097', '11', '177_2', '68', '1054', '274_1', '1083_2', '1094_1', '284_2', '134', '402', '539_1', '981', '693_2', '480_5', '1051', '166_1', '673', '128', '63', '271', '1048_3', '538', '874_1', '550_4', '605', '470_1', '632', '165_1', '864', '835', '37', '588', '1081_4', '962', '834', '288', '530', '929_1', '106_1', '476_1', '51', '226_3', '510', '513', '930', '237_1', '511', '174_1', '979_1', '633', '752_1', '247_4', '788_3', '979_3', '384', '812', '691', '788', '499', '204', '639_2', '932', '592', '122', '1046', '200_2', '396', '1095', '993', '420', '817', '745', '565', '568', '469', '810_1', '486', '905_5', '33', '1094', '1065_1', '739', '430_1', '868', '788_2', '220', '67_2', '787', '582', '695_1', '1083_3', '998_2', '525', '100', '778_1', '578', '676', '710_1', '294', '696', '427', '987', '110', '648', '332', '933_1', '766', '888', '177', '368_1', '281', '917', '595_2', '54', '534', '255_1', '25_1', '1083_5', '440', '1000', '368', '868_1', '353_2', '846', '492', '528_1', '48', '17_1', '724_1', '187_4', '100_2', '749', '730', '658', '7_1', '804', '1065', '196', '549', '388', '1050', '475', '1060', '153', '173_1', '334', '137_1', '1064', '132', '682', '857_3', '181', '315', '187_6', '1081_2', '968', '709', '574', '802', '795_4', '428_1', '150_1', '116', '731', '301', '705', '263', '1040_1', '193_1', '519_1', '733_1', '302_1', '371_2', '553', '124_3', '133_1', '480_1', '29', '27_1', '1023', '420_5', '595_1', '919_3', '796', '264_3', '657', '431_2', '471', '758', '855_2', '488', '184_7', '246_2', '323', '904_4', '623', '936', '319_1', '937', '624_1', '1079_2', '636', '953', '275', '153_2', '31_3', '142_1', '656', '660', '362_1', '429_4', '326', '1008', '816_2', '429_3', '831', '958', '1096', '187_3', '357', '657_1', '905', '770_1', '1003', '1013_2', '424_3', '297', '193_3', '118', '867', '929', '891', '24', '191', '1034', '736', '421_1', '165', '551_1', '976', '876', '113_1', '693_3', '264_1', '70_2', '744', '73', '903', '93', '319', '612_1', '662_2', '603_2', '1063_1', '779', '907', '172', '972_1', '298', '894', '529_1', '1096_1', '430_2', '169_1', '136', '369_4', '260', '919_1', '753', '814', '904_2', '275_2', '246', '715'] # need to change
      shuffle: 10000
      image_key: jpg
      image_transforms:
      - target: torchvision.transforms.Resize
        params:
          size: 512
          interpolation: 3
      - target: torchvision.transforms.RandomCrop
        params:
          size: 512
      process:
        - target: ldm.data.utils.AddStyle
          params:
            version: openai/clip-vit-large-patch14

        - target: ldm.data.utils.AddCannyRandomThreshold
          params:
            low_threshold: 40
            high_threshold: 110
            shift_range: 10

        - target: ldm.data.utils.AddSpatialPalette
          params:
            downscale_factor: 64

        - target: ldm.data.utils.PILtoTensor

lightning:
  find_unused_parameters: False

  modelcheckpoint:
    params:
      every_n_train_steps: 5000
      save_top_k: -1
      monitor: null
  trainer:
    benchmark: True
    num_sanity_val_steps: 0
    accumulate_grad_batches: 1
    limit_val_batches: 0